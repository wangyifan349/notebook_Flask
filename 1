import os
import shutil
import io
import zipfile
from flask import (
    Flask, request, jsonify, send_file,
    render_template_string, abort
)

# â€”â€” é…ç½®åŒº â€”â€” #
app = Flask(__name__)
# å­˜å‚¨æ ¹ç›®å½•
ROOT = os.path.join(os.path.dirname(__file__), 'storage')
os.makedirs(ROOT, exist_ok=True)

# â€”â€” å‰ç«¯æ¨¡æ¿ â€”â€” #
# ä½¿ç”¨ render_template_string æ¸²æŸ“ï¼Œå†…å« HTMLã€CSSã€JS
TEMPLATE = """
<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8">
  <title>Flask å•æ–‡ä»¶ç½‘ç›˜</title>
  <style>
    body { font-family: Arial; padding: 20px; }
    ul { list-style: none; padding-left: 20px; }
    li { margin: 5px; cursor: pointer; }
    .folder::before { content: "ğŸ“ "; }
    .file::before   { content: "ğŸ“„ "; }
    .dragging { opacity: 0.5; }
    .breadcrumb a { margin-right: 8px; text-decoration: none; color: #0066cc; }
  </style>
</head>
<body>
  <h1>Flask å•æ–‡ä»¶ç½‘ç›˜</h1>
  <div class="breadcrumb"></div>
  <button onclick="createFolder()">æ–°å»ºæ–‡ä»¶å¤¹</button>
  <input type="file" id="uploader">
  <button onclick="uploadFile()">ä¸Šä¼ æ–‡ä»¶</button>
  <button onclick="refresh()">åˆ·æ–°</button>
  <div id="tree"></div>

<script>
// å½“å‰æµè§ˆè·¯å¾„ï¼ˆç›¸å¯¹äºæ ¹ç›®å½•ï¼‰
let cwd = "";

// åˆå§‹åŒ–ï¼šåŠ è½½åˆ—è¡¨å’Œé¢åŒ…å±‘
window.onload = () => {
  refresh();
};

// æ›´æ–°æ–‡ä»¶æ ‘è§†å›¾
function refresh() {
  fetch(`/api/tree?path=${encodeURIComponent(cwd)}`)
    .then(res => res.json())
    .then(renderTree);
  renderBreadcrumb();
}

// æ¸²æŸ“é¢åŒ…å±‘å¯¼èˆª
function renderBreadcrumb() {
  const container = document.querySelector('.breadcrumb');
  container.innerHTML = '';
  // â€œæ ¹ç›®å½•â€é“¾æ¥
  container.appendChild(makeCrumb('', 'æ ¹ç›®å½•'));
  // æ‹†åˆ†å­è·¯å¾„ï¼Œé€çº§æ·»åŠ 
  const parts = cwd.split('/').filter(p => p);
  let accum = '';
  parts.forEach(name => {
    accum += name + '/';
    container.appendChild(makeCrumb(accum, name));
  });
}

// æ„é€ å•ä¸ªé¢åŒ…å±‘é“¾æ¥
function makeCrumb(path, label) {
  const a = document.createElement('a');
  a.textContent = label;
  a.href = '#';
  a.onclick = () => { cwd = path; refresh(); };
  return a;
}

// æ¸²æŸ“ç›®å½•/æ–‡ä»¶åˆ—è¡¨
function renderTree(items) {
  const tree = document.getElementById('tree');
  tree.innerHTML = '';
  const ul = document.createElement('ul');

  items.forEach(item => {
    const li = document.createElement('li');
    li.textContent = item.name;
    li.className = item.type;
    li.draggable = true;

    // åŒå‡»ï¼šè¿›å…¥æ–‡ä»¶å¤¹æˆ–ä¸‹è½½æ–‡ä»¶/æ‰“åŒ…æ–‡ä»¶å¤¹
    li.ondblclick = () => {
      if (item.type === 'folder') {
        cwd += item.name + '/';
        refresh();
      } else {
        window.location = `/api/download?path=${encodeURIComponent(cwd + item.name)}`;
      }
    };

    // å³é”®ï¼šé‡å‘½å / åˆ é™¤ / å¤åˆ¶ ç­‰æ“ä½œ
    li.oncontextmenu = e => {
      e.preventDefault();
      const action = prompt('æ“ä½œ (rename/delete/copy):', 'rename');
      if (!action) return;

      // æ•°æ®åˆå§‹åŒ–
      const data = { path: cwd + item.name };

      if (action === 'rename') {
        const newname = prompt('æ–°åç§°ï¼š', item.name);
        if (!newname) return;
        data.newname = newname;
      }
      if (action === 'copy') {
        const dest = prompt('å¤åˆ¶åˆ°è·¯å¾„ï¼ˆç›¸å¯¹æ ¹ï¼‰ï¼š', cwd);
        if (!dest) return;
        data.dest = dest;
      }
      callApi(action, data);
    };

    // æ‹–æ‹½ç§»åŠ¨
    li.ondragstart = e => {
      e.dataTransfer.setData('text/plain', cwd + item.name);
      li.classList.add('dragging');
    };
    li.ondragend = () => li.classList.remove('dragging');
    li.ondragover = e => e.preventDefault();
    li.ondrop = e => {
      e.preventDefault();
      const src = e.dataTransfer.getData('text/plain');
      const dest = cwd;
      callApi('move', { src, dest });
    };

    ul.appendChild(li);
  });

  tree.appendChild(ul);
}

// ç»Ÿä¸€è°ƒç”¨åç«¯ API
function callApi(action, data) {
  fetch(`/api/${action}`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(data)
  }).then(refresh);
}

// åˆ›å»ºæ–‡ä»¶å¤¹
function createFolder() {
  const name = prompt('æ–‡ä»¶å¤¹åç§°ï¼š');
  if (name) callApi('mkdir', { path: cwd + name });
}

// ä¸Šä¼ æ–‡ä»¶åˆ°å½“å‰ç›®å½•
function uploadFile() {
  const input = document.getElementById('uploader');
  if (input.files.length === 0) return alert('è¯·é€‰æ‹©æ–‡ä»¶');
  const form = new FormData();
  form.append('file', input.files[0]);
  form.append('path', cwd);

  fetch('/api/upload', { method: 'POST', body: form })
    .then(() => {
      input.value = '';
      refresh();
    });
}
</script>
</body>
</html>
"""

# â€”â€” è¾…åŠ©å‡½æ•° â€”â€” #
def safe_path(subpath):
    """
    å°†ç›¸å¯¹è·¯å¾„è½¬æ¢ä¸ºç»å¯¹è·¯å¾„ï¼Œå¹¶æ ¡éªŒå®‰å…¨æ€§ï¼Œé˜²æ­¢è¶Šç•Œè®¿é—®ã€‚
    """
    full = os.path.normpath(os.path.join(ROOT, subpath))
    # ç¡®ä¿ full åœ¨ ROOT ç›®å½•ä¸‹
    if os.path.commonpath([ROOT, full]) != ROOT:
        abort(400, 'éæ³•è·¯å¾„')
    return full

# â€”â€” è·¯ç”±å®šä¹‰ â€”â€” #

@app.route('/')
def index():
    """æ¸²æŸ“å‰ç«¯å•é¡µåº”ç”¨"""
    return render_template_string(TEMPLATE)

@app.route('/api/tree')
def api_tree():
    """
    è¿”å›æŒ‡å®šç›®å½•ä¸‹çš„æ–‡ä»¶å’Œæ–‡ä»¶å¤¹åˆ—è¡¨
    GET å‚æ•°ï¼špath=ç›¸å¯¹è·¯å¾„
    """
    rel = request.args.get('path', '')
    base = safe_path(rel)
    entries = sorted(os.listdir(base))
    result = []
    for name in entries:
        full = os.path.join(base, name)
        entry = {
            'name': name,
            'type': 'folder' if os.path.isdir(full) else 'file'
        }
        result.append(entry)
    return jsonify(result)

@app.route('/api/upload', methods=['POST'])
def api_upload():
    """
    ä¸Šä¼ æ–‡ä»¶åˆ°æŒ‡å®šç›®å½•
    è¡¨å•å­—æ®µï¼šfile, path
    """
    rel = request.form.get('path', '')
    file = request.files.get('file')
    if not file:
        abort(400, 'æœªæä¾›æ–‡ä»¶')
    dest = safe_path(os.path.join(rel, file.filename))
    file.save(dest)
    return '', 204

@app.route('/api/download')
def api_download():
    """
    ä¸‹è½½æ–‡ä»¶æˆ–æ‰“åŒ…ä¸‹è½½æ–‡ä»¶å¤¹
    GET å‚æ•°ï¼špath=ç›¸å¯¹è·¯å¾„
    """
    rel = request.args.get('path', '')
    target = safe_path(rel)

    if os.path.isdir(target):
        # å°†æ–‡ä»¶å¤¹æ‰“åŒ…ä¸º ZIP å¹¶è¿”å›
        buf = io.BytesIO()
        with zipfile.ZipFile(buf, 'w') as z:
            for root, _, files in os.walk(target):
                for fn in files:
                    full = os.path.join(root, fn)
                    # ä¿æŒç›¸å¯¹è·¯å¾„
                    relpath = os.path.relpath(full, target)
                    z.write(full, relpath)
        buf.seek(0)
        filename = os.path.basename(rel.rstrip('/')) + '.zip'
        return send_file(buf, as_attachment=True, download_name=filename)

    # æ™®é€šæ–‡ä»¶ä¸‹è½½
    return send_file(target, as_attachment=True)

# åˆå¹¶å¤šç§æ“ä½œåˆ°ä¸€ä¸ªè§†å›¾ï¼Œå‡å°‘æ–‡ä»¶çº§åˆ«è·¯ç”±åµŒå¥—
@app.route('/api/<action>', methods=['POST'])
def api_action(action):
    """
    æ”¯æŒ mkdir, rename, delete, copy, move æ“ä½œ
    POST JSON æ ¼å¼æ ¹æ®æ“ä½œè€Œå®š
    """
    data = request.get_json() or {}
    if action == 'mkdir':
        os.makedirs(safe_path(data['path']), exist_ok=True)

    elif action == 'rename':
        src = safe_path(data['path'])
        # ç›®æ ‡åæ‹¼æ¥åˆ°æºç›®å½•
        base = os.path.dirname(data['path'])
        dst = safe_path(os.path.join(base, data['newname']))
        os.rename(src, dst)

    elif action == 'delete':
        target = safe_path(data['path'])
        if os.path.isdir(target):
            shutil.rmtree(target)
        else:
            os.remove(target)

    elif action == 'copy':
        src = safe_path(data['path'])
        dst_dir = safe_path(data['dest'])
        name = os.path.basename(src)
        dst = os.path.join(dst_dir, name)
        # ç›®å½• or æ–‡ä»¶ å¤åˆ¶
        if os.path.isdir(src):
            shutil.copytree(src, dst)
        else:
            shutil.copy2(src, dst)

    elif action == 'move':
        src = safe_path(data['src'])
        dst_dir = safe_path(data['dest'])
        dst = os.path.join(dst_dir, os.path.basename(src))
        shutil.move(src, dst)

    else:
        abort(400, 'æœªçŸ¥æ“ä½œ')

    return '', 204

# â€”â€” å¯åŠ¨åº”ç”¨ â€”â€” #
if __name__ == '__main__':
    # å¼€å¯ debug æ¨¡å¼ä¾¿äºå¼€å‘è°ƒè¯•
    app.run(debug=True)
